<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bike Station Map</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAxd5Xu1D8hX1VLr4WHwOKoVqzfLZzM9Mo"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    /* 顶部 */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ccc;
      padding: 10px 20px;
      background-color: #f0f0f0;
    }

    header h1 {
      font-size: 36px;
      margin: 0;
      color: #333;
    }

    header a {
      font-size: 18px;
      text-decoration: none;
      color: #333;
      margin-left: 20px;
    }

    /* 左侧 */
    .left-panel {
      width: 25%;
      border-right: 1px solid #ccc;
      padding: 20px;
      position: fixed;
      top: 60px;
      left: 0;
      height: calc(100% - 60px);
      overflow-y: auto;
      background-color: #f0f0f0;
    }

    .left-panel h2 {
      font-size: 24px;
      margin: 0 0 20px;
      color: #333;
    }

    .left-panel label {
      display: block;
      font-size: 18px;
      margin-bottom: 10px;
      color: #333;
    }

    .left-panel input[type="text"],
    .left-panel input[type="date"],
    .left-panel input[type="time"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 18px;
      border: 1px solid #ccc;
    }

    .left-panel input[type="submit"] {
      padding: 10px;
      font-size: 18px;
      background-color: #333;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    /* 右侧 */
    .right-panel {
      width: 75%;
      margin-left: 25%;
    }

    #map {
      height: 100vh;
    }

    /* 底部 */
    footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      text-align: center;
      padding: 20px;
      border-top: 1px solid #ccc;
      background-color: #f0f0f0;
    }

    footer p {
      margin: 0;
      font-size: 18px;
      color: #333;
    }

    footer a {
      color: #333;
      text-decoration: none;
    }
      /* The Modal (background) */    
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgb(0,0,0); /* Fallback color */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }

    /* Modal Content/Box */
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto; /* 15% from the top and centered */
      padding: 20px;
      border: 1px solid #888;
      width: 80%; /* Could be more or less, depending on screen size */
    }

    /* The Close Button */
    .close {
      color: #aaaaaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: #000;
      text-decoration: none;
      cursor: pointer;
    }

  </style>
</head>

<body>
  <header>
    <div class="left">
      <div id="weather">
        <p id="temp"></p>
        <i id="weather-icon"></i>
      </div>
    </div>
    <div class="center">
      <h1>Dublin Bikes</h1>
    </div>
    <div class="right">
      <a href="#" id="view-map">View Map</a>
      <a href="#" id="view-stations">View Stations</a>
    </div>
  </header>
  <main>
    <div class="left-panel">
      <h2>Plan Your Journey</h2>
      <form>
        <label for="start-location">Please enter your starting location:</label>
        <input type="text" id="start-location" name="start-location">
        <br>
        <label for="end-location">Please enter your destination:</label>
        <input type="text" id="end-location" name="end-location">
        <br>
        <label for="date">Please input the day and your wish to travel:</label>
        <input type="date" id="date" name="date">
        <input type="time" id="time" name="time">
        <br>
        <input type="submit" value="Search">
      </form>
    </div>
    <div class="right-panel">
      <div id="map"></div>
      <div id="station-info">
        <h2 id="station-name"></h2>
        <p id="station-address"></p>
        <p id="station-availability"></p>
        <div id="weatherForecast"></div>
        <div id="chart">
          <canvas id="occupancyChart"></canvas>
        </div>
      </div>
    </div>
        <!-- Modal -->
    <div id="myModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <div id="stationInfo">
          <p>Station no.: <span id="stationNumber"></span></p>
          <p>Full address: <span id="fullAddress"></span></p>
          <p>Available bikes: <span id="availableBikes"></span></p>
          <p>Free stands: <span id="freeStands"></span></p>
          <p>Total capacity: <span id="totalCapacity"></span></p>
          <p>Credit cards accepted: <span id="creditCards"></span></p>
        </div>
  </div>
</div>

  </main>
  <div style="clear: both;"></div>
  <footer>
    <p>&copy; 2023 Dublin Bike Station. All rights reserved.</p>
  </footer>

  <script>
    // Fetch stations_data from app.py
    fetch("http://127.0.0.1:8080/stations", { mode: 'no-cors' })
      .then(response => {
        console.log(response);
        response => response.json()
      })
      .then(data => {
        window.stations = data;
        console.log(stations);
      })
      .catch(error => console.error(error));

    // Use jQuery to get stations_data json
    var jqxhr = $.getJSON("http://127.0.0.1:8080/stations", function (stations) {
      console.log("success one", stations);
      initMap(stations);
    })
      .done(function () {
        console.log("second success");
      })
      .fail(function () {
        console.log("error");
      })
      .always(function () {
        console.log("complete");
      })

    // window.onload = function () {
    //   initMap();
    // };


    // let map;

    // Get data from database
    // let stations = [];

    // Initialize the Google Map

    // window.onload = function () {
    //   initMap();
    // };

    function initMap(stations) {
  // 创建地图实例
  const map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 53.349805, lng: -6.26031 },
    zoom: 13
  });

  // 遍历所有站点
  Object.values(stations).forEach(station => {

    // 计算标记颜色
    const color = station.available_bikes / (station.available_bikes + station.available_bike_stands) * 100 > 50 ? "green" : "red";

    // 创建标记
    const marker = new google.maps.Marker({
      position: new google.maps.LatLng(station.position_lat, station.position_lng),
      map: map,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: station.available_bikes / 2,
        fillColor: color,
        fillOpacity: 0.8,
        strokeColor: "white",
        strokeWeight: 1
      }
    });

    // 创建信息窗口
    const infoWindow = new google.maps.InfoWindow();

    // 为标记添加监听器
    marker.addListener("click", () => {

      // 获取该站点的详细信息
      const stationInfo = `
        <p><strong>Station no.:</strong> ${station.number}</p>
        <p><strong>Full address:</strong> ${station.address}</p>
        <p><strong>Available bikes:</strong> ${station.available_bikes}</p>
        <p><strong>Free stands:</strong> ${station.available_bike_stands}</p>
        <p><strong>Total capacity:</strong> ${station.bike_stands}</p>
        <p><strong>Credit cards accepted:</strong> ${station.banking === "card" ? "Yes" : "No"}</p>
      `;

      // 显示信息窗口
      infoWindow.setContent(stationInfo);
      infoWindow.open(map, marker);
    });
  });
}

    async function fetchHourlyOccupancy(station_id) {
      const response = await fetch(`/api/hourly_occupancy?station_id=${station_id}`);
      const data = await response.json();
      return data;
    }

    async function fetchWeatherForecast(latitude, longitude) {
      const response = await fetch(`/api/weather_forecast?lat=${latitude}&lon=${longitude}`);
      const data = await response.json();
      return data;
    }

    async function fetchHourlyOccupancy(station_id) {
      const response = await fetch(`/api/hourly_occupancy?station_id=${station_id}`);
      const data = await response.json();
      return data;
    }

    async function displayOccupancyAndWeather(station) {
  document.getElementById("stationNumber").textContent = station.number;
  document.getElementById("fullAddress").textContent = station.address;
  document.getElementById("availableBikes").textContent = station.available_bikes;
  document.getElementById("freeStands").textContent = station.available_bike_stands;
  document.getElementById("totalCapacity").textContent = station.bike_stands;
  document.getElementById("creditCards").textContent = station.banking ? "Yes" : "No";

  // Fetch hourly occupancy data
  const hourlyOccupancy = await fetchHourlyOccupancy(station.number);

  // Create a bar chart for detailed hourly occupancy
  var ctx = document.getElementById("occupancyChart").getContext("2d");
  var chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: hourlyOccupancy.map((occupancy, index) => `Hour ${index + 1}`),
      datasets: [
        {
          label: "Hourly Occupancy",
          data: hourlyOccupancy,
          backgroundColor: "rgba(75, 192, 192, 0.2)",
          borderColor: "rgba(75, 192, 192, 1)",
          borderWidth: 1
        }
      ]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  // Fetch and display weather forecast
  const weatherForecastData = await fetchWeatherForecast(station.position_lat, station.position_lng);
  let weatherForecastHtml = "";
  weatherForecastData.forEach(function (forecast) {
    weatherForecastHtml += `<p>${forecast.hourly_dt}: ${forecast.hourly_weather_description}, Temp: ${forecast.hourly_temp} °C</p>`;
  });
  document.getElementById("weatherForecast").innerHTML = weatherForecastHtml;


      // Show the modal
      document.getElementById("myModal").style.display = "block";
    }


    google.maps.event.addDomListener(window, "load", initMap);
  </script>
</body>

</html>
