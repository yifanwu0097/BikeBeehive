<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bike Station Map</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAxd5Xu1D8hX1VLr4WHwOKoVqzfLZzM9Mo"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body, h1, h2 {
        margin: 0;
        padding: 0;
    }

    body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
    }

    /* Topbar and columns */
    .topbar {
        display: flex;
        justify-content: space-between;
        background-color: #333;
        padding: 1rem;
        color: #fff;
    }

    .column1 h1 {
        font-size: 24px;
    }

    .weather-info {
        display: flex;
        flex-direction: column;
    }

    .weekly-forecast {
        margin-top: 1rem;
    }

    /* Main content */
    main {
        display: flex;
    }

    .sidebar {
        width: 25%;
        background-color: #f4f4f4;
        padding: 1rem;
    }

    .map-section {
        width: 75%;
        padding: 1rem;
    }

    /* Search input and drawer */
    .search {
        margin-bottom: 2rem;
    }

    .search input {
        width: 100%;
        padding: 0.5rem;
    }

    .drawer {
        margin-top: 1rem;
        background-color: #ddd;
        padding: 1rem;
    }

    /* Plan Your Journey form */
    form {
        display: flex;
        flex-direction: column;
    }

    form label {
        margin-bottom: 0.3rem;
    }

    form input {
        margin-bottom: 1rem;
    }

    /* Map and charts */
    #map {
        height: 400px;
        margin-bottom: 1rem;
    }

    .chart-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }

    #hourly-chart, #daily-chart, .prediction-chart {
        flex-basis: 33%;
        height: 200px;
        background-color: #ddd;
        padding: 1rem;
    }

    /* Footer */
    footer {
        background-color: #333;
        color: #fff;
        text-align: center;
        padding: 1rem;
    }

    .icon-row {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }

    .icon-day {
      font-size: 18px;
      font-weight: bold;
      margin-right: 10px;
    }

    .icon-temp {
      font-size: 14px;
    }

    .icon-row img {
      width: 50px;
      height: 50px;
      display: inline-block;
    }

  </style>
</head>

<body>
    <header>
        <div class="topbar">
            <div class="column1">
                <h1>Dublin Bikes</h1>
            </div>
            <div class="column2">
                <div class="weather-info">
                    <span class="date">Today's Date</span>
                    <span class="temperature">Temperature</span>
                    <span class="weather-condition">Weather Condition</span>
                    <div id="weather"></div>
                </div>
                <div class="weekly-forecast">
                    Weekly Weather Forecast
                    <div id="fore-weather"></div>
                </div>
            </div>
        </div>
    </header>
    <main>
        <div class="sidebar">
    <div class="search">
        <input type="text" placeholder="Search" id="search-input">
        <div class="drawer">
            <div class="start-station">
                Start Station Information
            </div>
            <div class="end-station">
                End Station Information
            </div>
        </div>
        <h2>Plan Your Journey</h2>
        <form>
            <label for="start-location">Please enter your starting location:</label>
            <input type="text" id="start-location" name="start-location">
            <br>
            <label for="end-location">Please enter your destination:</label>
            <input type="text" id="end-location" name="end-location">
            <br>
            <label for="date">Please input the day and your wish to travel:</label>
            <input type="date" id="date" name="date">
            <input type="time" id="time" name="time">
            <br>
            <input type="submit" value="Search">
        </form>
            </div>
        </div>

        <div class="map-section">
            <div id="map">
                Google Map Display Area
            </div>
            <div class="chart-container">
                <div id="hourly-chart">
                    Average Hourly Availability Chart
                </div>
                <div id="daily-chart">
                    Daily Availability Chart
                </div>
                <div class="prediction-chart">
                    Prediction Chart
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="copyright">
            &copy; 2023 Dublin Bike Station. All rights reserved.
        </div>
    </footer>
</body>

  <script>
    google.charts.load('current', {'packages':['corechart']});
    displayCurrentWeather();
    displayForeWeather();
    function drawHourlyChart(station_id){
      fetch("http://127.0.0.1:8080/hourly/"+station_id).then(response=>{
        console.log(response);
        return response.json();
      }).then(data =>{
        var charData = new google.visualization.DataTable();
        charData.addColumn('number','Hour of Day');
        charData.addColumn('number','Available Bikes');
          data.forEach(hourlydata=>{
            charData.addRow([hourlydata[2], parseFloat(hourlydata[0].toString())]);
          });
          var options = {
            title: "Hourly Bike Availability",
            hAxis: {title: 'Hour of the Day',
                    ticks: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23]},
            vAxis: {title: 'Available Bike Number'},
            legend: 'none',
            width: '400'
          };
          var hourlyChart = new google.visualization.LineChart(document.getElementById('hourly-chart'));
          hourlyChart.draw(charData, options);
      }).catch(error => console.error(error));
      }

    function drawDailyChart(station_id){
      var weekday = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      fetch("http://127.0.0.1:8080/daily/"+station_id).then(response=>{
        console.log(response);
        return response.json();
      }).then(data => {
        var charData = new google.visualization.DataTable();
        charData.addColumn('string','Day of Week');
        charData.addColumn('number','Available Bikes');
          data.forEach(dailydata=>{
            charData.addRow([weekday[dailydata[2]],parseFloat(dailydata[0].toString())]);
          });
          var options = {
            title: 'Daily Bike Availability',
            hAxis: {title: 'Day of the Week'},
            vAxis: {title: 'Available Bike Number'},
            legend: 'none',
            width: '400'
          };
          var dailyChart = new google.visualization.LineChart(document.getElementById('daily-chart'));
          dailyChart.draw(charData, options);
      }).catch(error => console.error(error));
    }
      
    // Fetch stations_data from app.py
    fetch("http://127.0.0.1:8080/stations", { mode: 'no-cors' })
      .then(response => {
        console.log(response);
        response => response.json()
      })
      .then(data => {
        window.stations = data;
        console.log(stations);
      })
      .catch(error => console.error(error));

    // Use jQuery to get stations_data json
    var jqxhr = $.getJSON("http://127.0.0.1:8080/stations", function (stations) {
      console.log("success one", stations);
      initMap(stations);
    })
      .done(function () {
        console.log("second success");
      })
      .fail(function () {
        console.log("error");
      })
      .always(function () {
        console.log("complete");
      })
      

    // window.onload = function () {
    //   initMap();
    // };


    // let map;

    // Get data from database
    // let stations = [];

    // Initialize the Google Map

    // window.onload = function () {
    //   initMap();
    // };

    function initMap(stations) {
      const map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 53.349805, lng: -6.26031 },
        zoom: 13
      });

      Object.values(stations).forEach(station => {

        const color = station.available_bikes / (station.available_bikes + station.available_bike_stands) * 100 > 50 ? "green" : "red";

        // const color = "red";
        const marker = new google.maps.Marker({
          position: new google.maps.LatLng(station.position_lat, station.position_lng),
          map: map,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: station.available_bikes / 2,
            // scale: 8,
            fillColor: color,
            fillOpacity: 0.8,
            strokeColor: "white",
            strokeWeight: 1
          }
        });

        // Create an info window
        const infoWindow = new google.maps.InfoWindow({maxWidth: 320});

        marker.addListener("click", () => {
          const stationInfo = `
          <p><strong>Station no. :</strong>${station.number}</p>
          <p><strong>Station name:</strong> ${station.name}</p>
          <p><strong>Status:</strong> ${station.status}</p>
          <p><strong>Available bikes:</strong> ${station.available_bikes}</p>
          <p><strong>Free stands:</strong> ${station.available_bike_stands}</p>
          <p><strong>Credit cards accepted:</strong> ${station.banking === "True" ? "Yes" : "No"}</p>
          <div id="hourly-chart"></div>
          <div id="daily-chart"></div>
          `;
          infoWindow.setContent(stationInfo);
          infoWindow.open(map, marker);
          drawHourlyChart(station.number);
          drawDailyChart(station.number);
        });
      });
    }
    
    function displayCurrentWeather(){
      fetch("/weather").then(response =>{
        console.log(response);
        return response.json();
      }).then(data=>{
        const currentTemp = `
        <p>${Math.round(data['temp']- 273.15)}°C</p>
        <img src = "${iconGenerator(data['weather'][0]['icon'])}">
        `;
        const currentTempDiv = document.getElementById("weather");
        currentTempDiv.innerHTML = currentTemp;
      }).catch(error=>console.error(error));
    }

    function displayForeWeather(){
      fetch("/forecast/daily").then(response =>{
        console.log(response);
        return response.json();
      }).then(data=>{
        let foreWeather = ` `;
        // <p>Temparature:${Math.round(data[1]['temp']['day']-273.15)}°C</p>
        //<img src = "${iconGenerator(data[1]['weather'][0]['icon'])}">
        var i = 0;
        weekday = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']
        for(foreData of data){
          if (i == 7){break};
          var date = new Date(foreData.dt*1000);
          day = weekday[date.getDay()];
          if (i == 0){day = 'Today'};
          foreWeather += `
          <div class="icon-row">
          <div class="icon-day">${day}</div>
          <img src="${iconGenerator(foreData['weather'][0]['icon'])}">
          <div class="icon-temp">${Math.round(foreData['temp']['day']-273.15)}°C</div>
        </div>
          `;
          i++;
        }
        const foreWeatherDiv = document.getElementById("fore-weather");
        foreWeatherDiv.innerHTML = foreWeather;
      }).catch(error=>console.error(error));
    }

    function iconGenerator(id){
      return 'http://openweathermap.org/img/wn/'+id+'@2x.png';
    }

    google.maps.event.addDomListener(window, "load", initMap);
  </script>
</body>

</html>
